"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))(function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new t(function(r){r(e.value)}).then(s,a)}u((n=n.apply(e,r||[])).next())})},__generator=this&&this.__generator||function(e,r){function t(e){return function(r){return n([e,r])}}function n(t){if(o)throw new TypeError("Generator is already executing.");for(;u;)try{if(o=1,i&&(s=i[2&t[0]?"return":t[0]?"throw":"next"])&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[0,s.value]),t[0]){case 0:case 1:s=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,i=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(s=u.trys,!(s=s.length>0&&s[s.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){u.label=t[1];break}if(6===t[0]&&u.label<s[1]){u.label=s[1],s=t;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(t);break}s[2]&&u.ops.pop(),u.trys.pop();continue}t=r.call(e,u)}catch(e){t=[6,e],i=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}var o,i,s,a,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a};Object.defineProperty(exports,"__esModule",{value:!0});var caribviper_common_1=require("caribviper-common"),caribviper_entity_1=require("caribviper-entity"),lucene_data_objects_1=require("./../data/lucene-data-objects"),request=require("request"),Repository=function(){function e(e){this.dbo=e}return Object.defineProperty(e.prototype,"db",{get:function(){return this.dbo.database},enumerable:!0,configurable:!0}),e.prototype.save=function(e,r,t){return void 0===r&&(r=!0),void 0===t&&(t=void 0),__awaiter(this,void 0,void 0,function(){var n,o,i,s;return __generator(this,function(a){switch(a.label){case 0:if(!e._id&&!r)throw this.generateError("Failed to create entity","Invalid entity id");if(e.validateEntity(),!e.hasType||e._id||!r)return[3,5];a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.db.post(e)];case 2:if((i=a.sent()).ok)return e._rev=i.rev,e._id=i.id,[2,caribviper_entity_1.EntityMaps.mapEntityMap(t,e)];throw this.generateUnknownError();case 3:throw n=a.sent(),this.generateError("Failed to save","Unable to save entity");case 4:return[3,9];case 5:if(a.trys.push([5,8,,9]),e.isTransient)throw this.generateError("Failed to save","Entity is transient");return[4,this.db.get(e._id)];case 6:return o=a.sent(),e._rev=o._rev,[4,this.db.put(e)];case 7:if((i=a.sent()).ok)return e._rev=i.rev,[2,caribviper_entity_1.EntityMaps.mapEntityMap(t,e)];throw this.generateError("Failed to save","Unknown error occurred");case 8:if((s=a.sent()).error)throw new Error(s.error);throw this.generateError("Failed to save","Unknown error occurred");case 9:return[2]}})})},e.prototype.quickSave=function(e,r){return void 0===r&&(r=void 0),__awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(o){switch(o.label){case 0:if(o.trys.push([0,2,,3]),e.isTransient)throw this.generateError("Failed to save","Entity is transient");return e.validateEntity(),[4,this.db.put(e)];case 1:if((t=o.sent()).ok)return e._id=t.id,e._rev=t.rev,[2,caribviper_entity_1.EntityMaps.mapEntityMap(r,e)];throw this.generateUnknownError();case 2:throw n=o.sent(),new Error(JSON.stringify(n));case 3:return[2]}})})},e.prototype.delete=function(e){return __awaiter(this,void 0,void 0,function(){var r,t,n,o;return __generator(this,function(i){switch(i.label){case 0:i.trys.push([0,6,,7]),r=void 0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.db.get(e)];case 2:return r=i.sent(),[3,4];case 3:if((t=i.sent()).error)throw new Error(t.error);throw this.generateError("Unable to delete entity.","Possibly invalid id for entity");case 4:return[4,this.db.remove(r)];case 5:return n=i.sent(),[2,n.ok];case 6:throw o=i.sent(),this.generateError("Unable to delete entity");case 7:return[2]}})})},e.prototype.get=function(e,r){return void 0===r&&(r=void 0),__awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(o){switch(o.label){case 0:if(!e)throw this.generateError("Unable to fetch requested entity due to invalid id");o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.db.get(e)];case 2:return t=o.sent(),[2,caribviper_entity_1.EntityMaps.mapEntityMap(r,t)];case 3:if((n=o.sent()).error)throw new Error(n.error);throw this.generateError("Unable to fetch requested entity");case 4:return[2]}})})},e.prototype.find=function(e,r,t){return void 0===r&&(r=void 0),void 0===t&&(t=3),__awaiter(this,void 0,void 0,function(){var n,o;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,5]),[4,this.db.find(e)];case 1:if(!(n=i.sent()))throw new Error;return[2,caribviper_entity_1.EntityMaps.mapEntityMapArray(r,n.docs)];case 2:return("too_many_requests"===(o=i.sent()).error||429===o.status||500===o.status)&&t>1?[4,this.find(e,r,--t)]:[3,4];case 3:return[2,i.sent()];case 4:throw this.generateError("An error occurred executing the query");case 5:return[2]}})})},e.prototype.fetchAllByType=function(e,r,t){return void 0===e&&(e=void 0),void 0===r&&(r=void 0),void 0===t&&(t=3),__awaiter(this,void 0,void 0,function(){var n,o,i;return __generator(this,function(s){switch(s.label){case 0:return s.trys.push([0,5,,8]),e?[3,2]:[4,this.db.allDocs()];case 1:return n=s.sent(),[2,n.rows];case 2:return e.include_docs=!0,[4,this.db.allDocs(e)];case 3:return n=s.sent(),o=[],n.rows.forEach(function(e){o.push(caribviper_entity_1.EntityMaps.mapEntityMap(r,e.doc))}),[2,o];case 4:return[3,8];case 5:return("too_many_requests"===(i=s.sent()).error||429===i.status||500===i.status)&&t>1?[4,this.fetchAllByType(e,r,--t)]:[3,7];case 6:return[2,s.sent()];case 7:throw this.generateError("An error occurred fetching the entities");case 8:return[2]}})})},e.prototype.fetchAll=function(e,r){return void 0===e&&(e=void 0),void 0===r&&(r=3),__awaiter(this,void 0,void 0,function(){var t,n,o,i;return __generator(this,function(s){switch(s.label){case 0:return s.trys.push([0,5,,8]),e?[3,2]:[4,this.db.allDocs()];case 1:return n=s.sent(),[3,4];case 2:return[4,this.db.allDocs(e)];case 3:n=s.sent(),s.label=4;case 4:return t=n,e.include_docs?(o=[],t.rows.forEach(function(e){o.push(e.doc)}),[2,o]):[2,t.rows];case 5:return("too_many_requests"===(i=s.sent()).error||429===i.status||500===i.status)&&r>1?[4,this.fetchAll(e,--r)]:[3,7];case 6:return[2,s.sent()];case 7:throw this.generateError("An error occurred fetching the entities");case 8:return[2]}})})},e.prototype.queryByType=function(e,r,t,n){return void 0===r&&(r=void 0),void 0===t&&(t=void 0),void 0===n&&(n=3),__awaiter(this,void 0,void 0,function(){var o,i,s;return __generator(this,function(a){switch(a.label){case 0:return a.trys.push([0,5,,8]),r?[3,2]:[4,this.db.query(e)];case 1:return o=a.sent(),[2,o.rows];case 2:return r.include_docs=!0,[4,this.db.query(e,r)];case 3:return o=a.sent(),i=[],o.rows.forEach(function(e){i.push(caribviper_entity_1.EntityMaps.mapEntityMap(t,e.doc))}),[2,i];case 4:return[3,8];case 5:return("too_many_requests"===(s=a.sent()).error||429===s.status||500===s.status)&&n>1?[4,this.queryByType(e,r,t,--n)]:[3,7];case 6:return[2,a.sent()];case 7:throw this.generateError("An error occurred fetching the entities from the view");case 8:return[2]}})})},e.prototype.query=function(e,r,t){return void 0===r&&(r=void 0),void 0===t&&(t=3),__awaiter(this,void 0,void 0,function(){var n,o,i;return __generator(this,function(s){switch(s.label){case 0:return s.trys.push([0,5,,8]),r?[3,2]:[4,this.db.query(e)];case 1:return o=s.sent(),[3,4];case 2:return[4,this.db.query(e,r)];case 3:o=s.sent(),s.label=4;case 4:return n=o,[2,n.rows];case 5:return("too_many_requests"===(i=s.sent()).error||429===i.status||500===i.status)&&t>1?[4,this.query(e,r,--t)]:[3,7];case 6:return[2,s.sent()];case 7:throw this.generateError("An error occurred fetching the entities from the view");case 8:return[2]}})})},e.prototype.luceneQuery=function(e,r,t){return void 0===r&&(r=void 0),void 0===t&&(t=3),__awaiter(this,void 0,void 0,function(){var n,o,i;return __generator(this,function(s){switch(s.label){case 0:if(s.trys.push([0,2,,5]),!e)throw new Error("Invalid Lucene Fetch Options");return[4,this.executeLuceneSearch(e.url,e.secure)];case 1:for(n=s.sent(),o=0;o<n.rows.length;o++)n.rows[o]=lucene_data_objects_1.LuceneScoredRow.clone(n.rows[o]),n.rows[o].doc&&(n.rows[o].doc=caribviper_entity_1.EntityMaps.mapEntityMap(r,n.rows[o].doc));return[2,n];case 2:return("too_many_requests"===(i=s.sent()).error||429===i.status||500===i.status)&&t>1?[4,this.luceneQuery(e,r,--t)]:[3,4];case 3:return[2,s.sent()];case 4:throw this.generateError("An error occurred fetching the entities from the lucene index");case 5:return[2]}})})},e.prototype.bulkDocs=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(r){switch(r.label){case 0:if(!e||e.length<1)throw this.generateError("Bulk doc error","Unable to execute bulk document request due to empty docs parameter");return[4,this.db.bulkDocs(e)];case 1:return[2,r.sent()]}})})},e.prototype.generateError=function(r,t){return void 0===t&&(t=""),e.createError(r,t)},e.prototype.generateUnknownError=function(){return e.createError("Unknown error occurred")},e.createError=function(e,r){return void 0===r&&(r=""),caribviper_common_1.Assert.isTruthy(e,"Error for error message cannot be null/empty"),{error:e,reason:r||e}},e.prototype.executeLuceneSearch=function(e,r){void 0===r&&(r=!1);return new Promise(function(t,n){0!==e.indexOf("http:")&&0!==e.indexOf("https:")&&(e="http"+(r?"s":"")+"://"+e),request(e,null,function(e,r,o){return e?n(e):t(o?JSON.parse(o):JSON.parse("{}"))})})},e}();exports.Repository=Repository;